#
# SPDX-License-Identifier: GPL-2.0
#
# Copyright (c) 2013-2023 Igor Pecovnik, igor@armbian.com
#
# This file is a part of the Armbian Build Framework
# https://github.com/armbian/build/
#



declare -g LINUXFAMILY="sun60iw2"
declare -g ARCH="arm64"
declare -g ATF_COMPILE='no'
declare -g BOOTSCRIPT='boot-sun60iw2.cmd:boot.cmd'
declare -g BOOTENV_FILE='sun60iw2.txt'
declare -g OVERLAY_DIR="/boot/dtb/allwinner/overlay"
declare -g EXTRAWIFI="no"
declare -g KERNEL_BTF="no"
declare -g INSTALL_HEADERS="yes"


declare -g BOOTSOURCE="https://github.com/u-boot/u-boot.git"
declare -g BOOTPATCHDIR="u-boot-sun60iw2"

# Skip vendor U-Boot for mainline
if [[ "${BRANCH}" == "mainline" ]]; then
    return 0
fi




case "${BRANCH}" in
    legacy)
        KERNELSOURCE="${GITHUB_SOURCE}/radxa/kernel.git"
        KERNELBRANCH="branch:allwinner-aiot-linux-5.15"
		declare -g KERNEL_MAJOR_MINOR="5.15"
		KERNELPATCHDIR="archive/sun60iw2-${BRANCH}"

        ALLWINNER_BSP_SOURCE="${GITHUB_SOURCE}/radxa/allwinner-bsp"
		BSPBRANCH="branch:cubie-aiot-v1.4.6"
		
		ALLWINNER_DEVICE_SOURCE="${GITHUB_SOURCE}/radxa/allwinner-device"
		DEVICEBRANCH="branch:device-a733-v1.4.6"

		LINUXCONFIG="linux-sun60iw2-${BRANCH}"
		NAME_INITRD="initrd.img-5.15.147-legacy-sun60iw2"
		declare -g SERIALCON="ttyAS0"
		
        ;;
        
	vendor)
		KERNELSOURCE="${GITHUB_SOURCE}/radxa/kernel.git"
		KERNELBRANCH="branch:allwinner-aiot-linux-6.6"
		declare -g KERNEL_MAJOR_MINOR="6.6"
		KERNELPATCHDIR="archive/sun60iw2-${BRANCH}"
		
		ALLWINNER_BSP_SOURCE="${GITHUB_SOURCE}/radxa/allwinner-bsp"
		BSPBRANCH="branch:cubie-aiot-v1.4.8"
		
		ALLWINNER_DEVICE_SOURCE="${GITHUB_SOURCE}/radxa/allwinner-device"
		DEVICEBRANCH="branch:device-a733-v1.4.8"
		
		LINUXCONFIG="linux-sun60iw2-${BRANCH}"
		NAME_INITRD="initrd.img-6.6.98-vendor-sun60iw2"
		declare -g SERIALCON="ttyAS0"
		
	;;

        mainline)
                # Upstream kernel 6.19 (A733 support lands here)
	        KERNELSOURCE="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git"
	        KERNELBRANCH="tag:v6.19"
	        declare -g KERNEL_MAJOR_MINOR="6.19"

	        # No BSP patches apply to mainline â€” disable them
	        KERNELPATCHDIR=""
	        ALLWINNER_BSP_SOURCE=""
	        ALLWINNER_DEVICE_SOURCE=""
	        BSPBRANCH=""
	        DEVICEBRANCH=""

	        # Use a minimal config (you will need to refine this)
	        LINUXCONFIG="linux-sun60iw2-mainline"

	        # Initrd naming
	        NAME_INITRD="initrd.img-6.19.0-mainline-sun60iw2"

	        declare -g SERIALCON="ttyAMA0"
        ;;

esac


function write_uboot_platform() {
    local BOOTLOADER="${1}"
    local DEVICE="${2}"

    dd if="${BOOTLOADER}/u-boot-sunxi-with-spl.bin" \
       of="${DEVICE}" bs=1024 seek=8 conv=notrunc
}


function build_custom_uboot() {
    display_alert "Checking for local Radxa U-Boot blob" "${BOARD}" "info"

    # Define local path
    local local_blob_dir="${SRC}/packages/blobs/sunxi/sun60iw2"
    local local_blob=$(ls ${local_blob_dir}/u-boot-aw2501*.deb 2>/dev/null | head -n 1)

    if [[ -f "${local_blob}" ]]; then
        display_alert "Using local blob: $(basename "${local_blob}")" "${BOARD}" "info"
        DEB_VENDOR_BLOB="${local_blob}"
        DOWNLOAD_DIR="" # Prevent cleanup of local source
    else
        display_alert "Local blob not found, retrieving latest from GitHub" "${BOARD}" "info"
        api_url="https://api.github.com/repos/radxa-pkg/u-boot-aw2501/releases/latest"
        latest_version=$(curl -s "${api_url}" | jq -r '.tag_name')
        
        DOWNLOAD_URL="https://github.com/radxa-pkg/u-boot-aw2501/releases/download/${latest_version}/u-boot-aw2501_${latest_version}_all.deb"
        
        DOWNLOAD_DIR=$(mktemp -d)
        DEB_VENDOR_BLOB="${DOWNLOAD_DIR}/u-boot-aw2501_${latest_version}_all.deb"
        wget ${DOWNLOAD_URL} -P ${DOWNLOAD_DIR}
    fi

    [[ -z "${uboottempdir:-}" ]] && exit_with_error "uboottempdir is not set by caller"
    [[ -z "${uboot_name:-}" ]] && exit_with_error "uboot_name is not set by caller"

    # 4. Extract and Repackage
    vendortmp=$(mktemp -d)
    ( cd "${vendortmp}" && dpkg-deb -x "${DEB_VENDOR_BLOB}" . ) || {
        rm -rf "${vendortmp}" ${DOWNLOAD_DIR}
        exit_with_error "Failed to extract vendor .deb: ${DEB_VENDOR_BLOB}"
    }

    mkdir -p "${uboottempdir}/usr/lib/${uboot_name}"

    local srcdir=""
    if [[ -d "${vendortmp}/usr/lib/u-boot/${BOARD}" ]]; then
        srcdir="${vendortmp}/usr/lib/u-boot/${BOARD}"
    fi
    
    if [[ -n "${srcdir}" ]]; then
        local required_files=("boot0_sdcard.bin" "boot0_ufs.bin" "boot_package.fex")
        local found_any=false

        for filename in "${required_files[@]}"; do
            local src_file="${srcdir}/${filename}"
            local dest_dir="${uboottempdir}/usr/lib/${uboot_name}/"

            if [[ -f "${src_file}" ]]; then
                if cp "${src_file}" "${dest_dir}"; then
                    display_alert "Successfully copied ${filename}" "${BOARD}" "info"
                    found_any=true
                else
                    display_alert "Failed to copy ${filename} to destination" "${BOARD}" "err"
                fi
            else
                display_alert "Required file missing from vendor package: ${filename}" "${BOARD}" "warn"
            fi
        done

        if [[ "${found_any}" == "false" ]]; then
            rm -rf "${vendortmp}" ${DOWNLOAD_DIR}
            exit_with_error "Critical: No boot binaries were found in ${srcdir}"
        fi
    else
        rm -rf "${vendortmp}" ${DOWNLOAD_DIR}
        exit_with_error "Vendor package layout not found for board: ${BOARD}"
    fi

    # 5. Cleanup temporary extraction files (leaves local .deb intact)
    rm -rf "${vendortmp}" ${DOWNLOAD_DIR}

    declare -g EXTENSION_BUILT_UBOOT="yes"

    return 0
}


function kernel_copy_extra_sources__radxa_allwinner_bsp() {
    # Do nothing for mainline kernel (no BSP integration)
    if [[ "${BRANCH}" == "mainline" ]]; then
        return 0
    fi

    display_alert "$BOARD" "Retrieving latest Radxa Allwinner BSP (Board Support Package)" "info"

    allwinner_bsp_git_bare_tree="${SRC}/cache/git-bare/allwinner-bsp"
    declare allwinner_bsp_git_bare_tree_done_marker="${allwinner_bsp_git_bare_tree}/.git/armbian-bare-tree-done"

    if [ ! -d "${allwinner_bsp_git_bare_tree}" ] || [ ! -f "${allwinner_bsp_git_bare_tree_done_marker}" ]; then
        if [[ -d "${allwinner_bsp_git_bare_tree}" ]]; then
            rm -rf "${allwinner_bsp_git_bare_tree}"
        fi

        run_host_command_logged git clone --tags --no-checkout \
            "${ALLWINNER_BSP_SOURCE}" "${allwinner_bsp_git_bare_tree}"

        touch "${allwinner_bsp_git_bare_tree_done_marker}"
    fi

    git_ensure_safe_directory "${allwinner_bsp_git_bare_tree}"

    GIT_FIXED_WORKDIR="${LINUXSOURCEDIR}/bsp" \
        GIT_BARE_REPO_FOR_WORKTREE="${allwinner_bsp_git_bare_tree}" \
        GIT_BARE_REPO_INITIAL_BRANCH="${BSPBRANCH#*:}" \
        fetch_from_repo "${ALLWINNER_BSP_SOURCE}" "allwinner_bsp:${KERNEL_MAJOR_MINOR}" "${BSPBRANCH}" "yes"

    local expected_dir="${kernel_work_dir}/bsp"
    local wait_count=0
    while [[ ! -d "${expected_dir}/configs" ]] && [[ $wait_count -lt 60 ]]; do
        display_alert "Waiting for BSP files to appear" "Wait time: $((wait_count * 2))s" "info"
        sleep 2
        wait_count=$((wait_count + 1))
    done
    
    local CURRENT_BSP_HASH=$(cd "${expected_dir}" && git log -n 1 --abbrev=10 --pretty=format:"%h")
    
    local PATCH_ARCHIVE_DIR="${SRC}/patch/kernel/archive/sun60iw2-${BRANCH}"
	local EXISTING_BSP_FILE=""
	local EXISTING_BSP_HASH=""
	if compgen -G "${PATCH_ARCHIVE_DIR}/0011-Add-BSP-support-files-"*.patch > /dev/null; then
    	EXISTING_BSP_FILE=$(basename "$(ls "${PATCH_ARCHIVE_DIR}/0011-Add-BSP-support-files-"*.patch 2>/dev/null | head -n 1)")
    	EXISTING_BSP_HASH=$(echo "${EXISTING_BSP_FILE}" | grep -oP 'files-\K[a-f0-9]+(?=\.patch)')
	fi
    
    local PATCH_TARGET_DIR="${SRC}/cache/patch/radxa-${BRANCH}"
    mkdir -p "${PATCH_TARGET_DIR}"
    
    local PATCH_NAME="0011-Add-BSP-support-files-${CURRENT_BSP_HASH}.patch"
    local FULL_PATCH_PATH="${PATCH_TARGET_DIR}/${PATCH_NAME}"

    if [[ -f "${FULL_PATCH_PATH}" ]] || [[ -n "${CURRENT_BSP_HASH}" && "${CURRENT_BSP_HASH}" == "${EXISTING_BSP_HASH}" ]]; then
        display_alert "$BOARD" "BSP patch for hash ${CURRENT_BSP_HASH} exists. Skipping." "info"
        return 0
    fi
    
    display_alert "$BOARD" "New remote state detected (${CURRENT_BSP_HASH}). Updated patches stored in ${FULL_PATCH_PATH}" "info"
    rm -f "${PATCH_TARGET_DIR}/0010-BSP-Autogen-File.patch"
    rm -f "${PATCH_TARGET_DIR}"/0011-Add-BSP-support-files-*.patch

    if [[ -d "${expected_dir}" ]]; then
        run_host_command_logged cp "${expected_dir}"/configs/linux-${KERNEL_MAJOR_MINOR}/*.dtsi "${kernel_work_dir}"/arch/arm64/boot/dts/allwinner
        run_host_command_logged cp -r "${expected_dir}"/include/dt-bindings/. "${kernel_work_dir}"/include/dt-bindings

        local insert_text="\
export BSP_TOP := bsp/\n\
export LICHEE_KERN_DIR := ./\n\
export KBUILD_DEFCONFIG := bsp.config\n\
"
        sed -i "/# expect to learn how to build the kernel reading this file./a\\
${insert_text}" "${kernel_work_dir}/Makefile"

		local bsp_patch_file="${PATCH_TARGET_DIR}/0010-BSP-Autogen-File.patch"
        local autogen_content="#define AW_BSP_VERSION \"${CURRENT_BSP_HASH}, $(date "+%Y-%m-%d %H:%M:%S"), RadxaOS SDK\""
        mkdir -p "${expected_dir}/include"
        echo "${autogen_content}" > "${expected_dir}/include/sunxi-autogen.h"
        
        display_alert "$BOARD" "Generating 0010-BSP-Autogen-File.patch" "info"
        (
        	{  
            	echo "--- /dev/null"
            	echo "+++ b/bsp/include/sunxi-autogen.h"
            	echo "@@ -0,0 +1 @@"
            	echo "+${autogen_content}"  
        	} > "${bsp_patch_file}"
        	
        	display_alert "$BOARD" "Generating ${PATCH_NAME}" "info"
            cd "${kernel_work_dir}" || exit_with_error "Failed to cd to kernel_work_dir"
            git config user.email "support@armbian.com"
            git config user.name "Armbian Builder"

            git add Makefile
            git add arch/arm64/boot/dts/allwinner/*.dtsi
            git add include/dt-bindings/
            
            git commit -m "Add BSP support files ${CURRENT_BSP_HASH}"
            git format-patch -1 --stdout > "${FULL_PATCH_PATH}"
            
            git reset --hard HEAD~1
            git clean -fd
        ) || exit_with_error "BSP patch generation failed"
    else
        display_alert "Radxa Allwinner BSP not found." "${BOARD}" "err"
    fi
}


function kernel_copy_extra_sources__radxa_allwinner_device() {

    # Skip Radxa Allwinner Device integration for mainline kernel
    if [[ "${BRANCH}" == "mainline" ]]; then
        return 0
    fi


    display_alert "$BOARD" "Retrieving latest Radxa Allwinner Device" "info"
    
    local REMOTE_BRANCH_NAME="${DEVICEBRANCH#*:}"
    local CURRENT_REMOTE_HASH=$(git ls-remote "${ALLWINNER_DEVICE_SOURCE}" "refs/heads/${REMOTE_BRANCH_NAME}" | awk '{print substr($1,1,10)}')
    
    if [[ -z "${CURRENT_REMOTE_HASH}" ]]; then
        display_alert "$BOARD" "Could not retrieve remote hash for ${REMOTE_BRANCH_NAME}. Proceeding with caution." "err"
    fi

    local PATCH_ARCHIVE_DIR="${SRC}/patch/kernel/archive/sun60iw2-${BRANCH}"
    local EXISTING_PATCH_FILE=""
    local EXISTING_PATCH_HASH=""
    if compgen -G "${PATCH_ARCHIVE_DIR}/0012-Add-Allwinner-Device-a733-"*.patch > /dev/null; then
        EXISTING_PATCH_FILE=$(basename "$(ls "${PATCH_ARCHIVE_DIR}/0012-Add-Allwinner-Device-a733-"*.patch 2>/dev/null | head -n 1)")
        EXISTING_PATCH_HASH=$(echo "${EXISTING_PATCH_FILE}" | grep -oP 'a733-\K[a-f0-9]+(?=\.patch)')
    fi

    local PATCH_TARGET_DIR="${SRC}/cache/patch/radxa-${BRANCH}"
    mkdir -p "${PATCH_TARGET_DIR}"
    
    local PATCH_NAME="0012-Add-Allwinner-Device-a733-${CURRENT_REMOTE_HASH}.patch"
    local FULL_PATCH_PATH="${PATCH_TARGET_DIR}/${PATCH_NAME}"

    if [[ -f "${FULL_PATCH_PATH}" ]] || [[ -n "${CURRENT_REMOTE_HASH}" && "${CURRENT_REMOTE_HASH}" == "${EXISTING_PATCH_HASH}" ]]; then
        display_alert "$BOARD" "Device patch for hash ${CURRENT_REMOTE_HASH} exists. Skipping." "info"
        return 0
    fi

    display_alert "$BOARD" "New remote state detected (${CURRENT_REMOTE_HASH}). Updated patch stored in ${FULL_PATCH_PATH}" "info"
    rm -f "${PATCH_TARGET_DIR}"/0012-Add-Allwinner-Device-a733*.patch
    
    allwinner_device_git_bare_tree="${SRC}/cache/git-bare/allwinner-device"
    declare allwinner_device_git_bare_tree_done_marker="${allwinner_device_git_bare_tree}/.git/armbian-bare-tree-done"

    if [ ! -d "${allwinner_device_git_bare_tree}" ] || [ ! -f "${allwinner_device_git_bare_tree_done_marker}" ]; then
        if [[ -d "${allwinner_device_git_bare_tree}" ]]; then
            rm -rf "${allwinner_device_git_bare_tree}"
        fi
        run_host_command_logged git clone --tags --no-checkout \
            "${ALLWINNER_DEVICE_SOURCE}" "${allwinner_device_git_bare_tree}"
        touch "${allwinner_device_git_bare_tree_done_marker}"
    fi

    git_ensure_safe_directory "${allwinner_device_git_bare_tree}"

    GIT_FIXED_WORKDIR="allwinner-device" \
        GIT_BARE_REPO_FOR_WORKTREE="${allwinner_device_git_bare_tree}" \
        GIT_BARE_REPO_INITIAL_BRANCH="${REMOTE_BRANCH_NAME}" \
        fetch_from_repo "${ALLWINNER_DEVICE_SOURCE}" "allwinner_device:${KERNEL_MAJOR_MINOR}" "${DEVICEBRANCH}" "yes"
    
    local expected_dir="${SRC}/cache/sources/allwinner-device"
    
    local wait_count=0
    while [[ ! -d "${expected_dir}/configs" ]] && [[ $wait_count -lt 60 ]]; do
    display_alert "Waiting for Device files" "Wait time: $((wait_count * 2))s" "info"
        sleep 2
        wait_count=$((wait_count + 1))
    done
    
    if [[ -d "${expected_dir}" ]]; then
        run_host_command_logged cp "${expected_dir}/configs/cubie_a7a/linux-${KERNEL_MAJOR_MINOR}/board.dts" "${kernel_work_dir}/arch/arm64/boot/dts/allwinner/sun60i-a733-cubie-a7a.dts"
        run_host_command_logged cp "${expected_dir}/configs/cubie_a7s/linux-${KERNEL_MAJOR_MINOR}/board.dts" "${kernel_work_dir}/arch/arm64/boot/dts/allwinner/sun60i-a733-cubie-a7s.dts"
        run_host_command_logged cp "${expected_dir}/configs/cubie_a7z/linux-${KERNEL_MAJOR_MINOR}/board.dts" "${kernel_work_dir}/arch/arm64/boot/dts/allwinner/sun60i-a733-cubie-a7z.dts"
        run_host_command_logged cp "${expected_dir}/configs/default/linux-${KERNEL_MAJOR_MINOR}/bsp_defconfig" "${kernel_work_dir}/arch/arm64/configs/bsp.config"
        
        display_alert "$BOARD" "Generating ${PATCH_NAME}" "info"
        (
            cd "${kernel_work_dir}" || exit_with_error "Failed to cd to kernel_work_dir"
            git config user.email "support@armbian.com"
            git config user.name "Armbian Builder"
            git add .
            git commit -m "Add Allwinner Device a733 ${CURRENT_REMOTE_HASH}"
            git format-patch -1 --stdout > "${FULL_PATCH_PATH}"
            
            git reset --hard HEAD~1
            git clean -fd
        ) || exit_with_error "Device patch generation failed"
    else
        display_alert "Radxa Allwinner Device not found." "${BOARD}" "err"
    fi
}


function post_family_tweaks__install_kmscon_console() {
    display_alert "Installing KMSCON (KMS/DRM-based system console)" "${BOARD}" "info"

    local HOST_DEB_PATH="${SRC}/packages/blobs/sunxi/sun60iw2"
    local TMP_DEB_DIR="/tmp/kmscon_debs" 
    local TARGET_WANTS_DIR="/etc/systemd/system/getty.target.wants"
    local TARGET_SERVICE_FILE="/usr/lib/systemd/system/kmsconvt@.service"

    mkdir -p "${SDCARD}${TMP_DEB_DIR}"

    cp "${HOST_DEB_PATH}/kmscon_9.2.1-1_arm64.deb" "${SDCARD}${TMP_DEB_DIR}/"
    cp "${HOST_DEB_PATH}/libtsm4_4.3.0-1_arm64.deb" "${SDCARD}${TMP_DEB_DIR}/"
    
    chroot "$SDCARD" /bin/bash << EOF
        apt-get update
        apt-get install -y --no-install-recommends libegl1 libgbm1 libgles2

        cd ${TMP_DEB_DIR}
        dpkg -i *.deb
        
        rm -rf ${TMP_DEB_DIR}
EOF
    if [ $? -ne 0 ]; then
    	display_alert "KMSCON CRITICAL ERROR: Failed to install runtime dependencies or DEB packages. Aborting." "${BOARD}" "err"
        exit 1
    fi
    
    mkdir -p "${SDCARD}${TARGET_WANTS_DIR}"
    
    chroot "$SDCARD" /bin/bash -c "rm -f ${TARGET_WANTS_DIR}/getty@tty1.service" 
    chroot "$SDCARD" /bin/bash -c "ln -sf ${TARGET_SERVICE_FILE} ${TARGET_WANTS_DIR}/kmsconvt@tty1.service"
    chroot "$SDCARD" /bin/bash -c "ln -sf ${TARGET_SERVICE_FILE} /etc/systemd/system/autovt@.service"
    
	local OVERRIDE_DIR="${SDCARD}/etc/systemd/system/kmsconvt@tty1.service.d"
	mkdir -p "$OVERRIDE_DIR"

	cat <<EOF > "${OVERRIDE_DIR}/override.conf"
	[Service]
	ExecStart=
	ExecStart=-/usr/bin/kmscon --vt tty1 --login -- /bin/bash --login
EOF
}


function post_family_tweaks__install_overlays() {
	display_alert "$BOARD" "Retrieving latest Radxa overlay package"  "info"
	
	api_url="https://api.github.com/repos/radxa-pkg/radxa-overlays/releases/latest"
	overlay_version=$(curl -s "${api_url}" | jq -r '.tag_name')
	
	overlay_url="https://github.com/radxa-pkg/radxa-overlays/releases/download/${overlay_version}/radxa-overlays-dkms_${overlay_version}_all.deb"
	
	overlay_dkms_file_name="radxa-overlays-dkms_${overlay_version}_all.deb"
	
	use_clean_environment="yes" chroot_sdcard "wget ${overlay_url} -P /tmp"
	display_alert "Install Radxa Overlay package, will build kernel module in chroot" "${EXTENSION}" "info"
	declare -ag if_error_find_files_sdcard=("/var/lib/dkms/radxa-overlays*/*/build/*.log")
	use_clean_environment="yes" chroot_sdcard_apt_get_install "/tmp/${overlay_dkms_file_name}"
	use_clean_environment="yes" chroot_sdcard "rm -f /tmp/radxa-overlays*.deb"
	
	use_clean_environment="yes" chroot_sdcard "mkdir /boot/overlays"
	if [[ "${BRANCH}" == "legacy" ]]; then
		use_clean_environment="yes" chroot_sdcard "cp -R /var/lib/dkms/radxa-overlays/${overlay_version}/5.15.147-legacy-sun60iw2/aarch64/module/arch/arm64/boot/dts/allwinner/overlays/* /boot/overlays"
	else
		use_clean_environment="yes" chroot_sdcard "cp -R /var/lib/dkms/radxa-overlays/${overlay_version}/6.6.98-vendor-sun60iw2/aarch64/module/arch/arm64/boot/dts/allwinner/overlays/* /boot/overlays"
	fi
}


function write_uboot_platform() {
    local SCRIPT_DIR="$1"
    local DEVICE="$2"

    dd conv=notrunc,fsync status=none if="$SCRIPT_DIR/boot0_sdcard.bin" of="$DEVICE" bs=512 seek=256
    dd conv=notrunc,fsync status=none if="$SCRIPT_DIR/boot0_ufs.bin" of="$DEVICE" bs=512 seek=2064
    dd conv=notrunc,fsync status=none if="$SCRIPT_DIR/boot_package.fex" of="$DEVICE" bs=512 seek=24576
    sync "${DEVICE}"
    
    sfdisk --part-label "$DEVICE" 1 "primary"
}


family_tweaks() {
	# execute specific tweaks function if present
	[[ $(type -t family_tweaks_s) == function ]] && family_tweaks_s
	
	# KMSCON does not start until login screen appears. Turn on splash.
	if [[ "${BRANCH}" == "legacy" && -f "${SDCARD}/boot/armbianEnv.txt" ]]; then
    	if grep -q '^bootlogo' "${SDCARD}/boot/armbianEnv.txt"; then
        	sed -i 's/^bootlogo.*/bootlogo=true/' "${SDCARD}/boot/armbianEnv.txt"
    	else
        	echo 'bootlogo=true' >> "${SDCARD}/boot/armbianEnv.txt"
    	fi
	fi
	echo "galcore" >> "${SDCARD}"/etc/modules
	cp -R "${SRC}"/packages/blobs/sunxi/sun60iw2/logo.bmp "${SDCARD}"/boot
	echo "ramdisk_file=${NAME_INITRD}" >> "${SDCARD}"/boot/armbianEnv.txt
	echo "extraargs=clk_ignore_unused mac_addr=${mac} coherent_pool=2M irqchip.gicv3_pseudo_nmi=0 cgroup_enable=cpuset cgroup_memory=1 swapaccount=1 kasan=off no_console_suspend fsck.fix=yes fsck.repair=yes net.ifnames=0" >> "${SDCARD}"/boot/armbianEnv.txt
}


if [[ "${BRANCH}" == "mainline" ]]; then
    BOOTSOURCE="https://github.com/u-boot/u-boot.git"
    BOOTBRANCH="tag:master"
    BOOTPATCHDIR="u-boot-sun60iw2"
fi
